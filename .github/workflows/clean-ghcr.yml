name: ğŸ§¹ Clean GHCR SHA256 Images

on:
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤© UTC 3 ç‚¹æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 11 ç‚¹ï¼‰

permissions:
  packages: write  # éœ€è¦å†™æƒé™ä»¥åˆ é™¤é•œåƒ
  contents: read   # éœ€è¦è¯»æƒé™ä»¥è®¿é—®ä»“åº“ä¿¡æ¯

jobs:
  clean:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¾ Delete SHA256-tagged GHCR images
        env:
          GH_TOKEN: ${{ secrets.GHCR_TOKEN }}
          REPO_NAME: ${{ github.repository }}
        run: |
          # æå–ä»“åº“åç§°ï¼ˆä» owner/repo ä¸­è·å– repo éƒ¨åˆ†ï¼‰
          PACKAGE_NAME=$(echo $REPO_NAME | cut -d'/' -f2)

          # è·å–æ‰€æœ‰ SHA256 æ ‡ç­¾çš„é•œåƒç‰ˆæœ¬ ID
          VERSIONS=$(gh api -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            /user/packages/container/$PACKAGE_NAME/versions \
            --paginate | jq -r '.[] | select(.metadata.container.tags[] | startswith("sha256:")) | .id')

          # æ£€æŸ¥æ˜¯å¦æœ‰ SHA256 æ ‡ç­¾çš„ç‰ˆæœ¬
          if [ -z "$VERSIONS" ]; then
            echo "âœ… No SHA256-tagged versions found."
            exit 0
          fi

          # éå†å¹¶åˆ é™¤æ¯ä¸ª SHA256 æ ‡ç­¾çš„ç‰ˆæœ¬
          for vid in $VERSIONS; do
            echo "ğŸ—‘ï¸ Deleting version ID: $vid"
            gh api -X DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GH_TOKEN" \
              /user/packages/container/$PACKAGE_NAME/versions/$vid
          done
