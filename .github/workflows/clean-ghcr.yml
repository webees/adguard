name: üßπ Clean GHCR Untagged

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

permissions:
  packages: write
  contents: read

jobs:
  clean:
    runs-on: ubuntu-latest
    steps:
      - name: üßæ Delete untagged GHCR images
        env:
          GH_TOKEN: ${{ secrets.GHCR_TOKEN }}
          REPO_NAME: ${{ github.repository }}
        run: |
          PACKAGE_NAME=$(echo $REPO_NAME | cut -d'/' -f2)

          VERSIONS=$(gh api -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            /user/packages/container/$PACKAGE_NAME/versions \
            --paginate | jq -r '.[] | select(.metadata.container.tags | length == 0) | .id')

          if [ -z "$VERSIONS" ]; then
            echo "‚úÖ No untagged versions found."
            exit 0
          fi

          for vid in $VERSIONS; do
            echo "üóëÔ∏è Deleting version ID: $vid"
            gh api -X DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GH_TOKEN" \
              /user/packages/container/$PACKAGE_NAME/versions/$vid
          done
