name: ğŸ§¹ Clean GHCR SHA256 Images

on:
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤© UTC 3 ç‚¹æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 11 ç‚¹ï¼‰

permissions:
  packages: write  # éœ€è¦å†™æƒé™ä»¥åˆ é™¤é•œåƒ
  contents: read   # éœ€è¦è¯»æƒé™ä»¥è®¿é—®ä»“åº“ä¿¡æ¯

jobs:
  clean:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¾ Delete SHA256-named GHCR images
        env:
          GH_TOKEN: ${{ github.token }}  # ä½¿ç”¨é»˜è®¤ GITHUB_TOKEN
          REPO_NAME: ${{ github.repository }}
          PACKAGE_NAME: adguard  # æ˜ç¡®æŒ‡å®šåŒ…å
        run: |
          # è°ƒè¯•ï¼šè¾“å‡ºç¯å¢ƒå˜é‡
          echo "ğŸ” REPO_NAME: $REPO_NAME"
          echo "ğŸ” PACKAGE_NAME: $PACKAGE_NAME"

          # è·å–æ‰€æœ‰é•œåƒç‰ˆæœ¬å¹¶è°ƒè¯•è¾“å‡º
          echo "ğŸ” Fetching all package versions for $PACKAGE_NAME..."
          VERSIONS_JSON=$(gh api -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            /user/packages/container/$PACKAGE_NAME/versions \
            --paginate)

          # æ£€æŸ¥ JSON æ•°æ®æ˜¯å¦ä¸ºç©º
          if [ -z "$VERSIONS_JSON" ]; then
            echo "âŒ No versions found or API request failed."
            exit 1
          fi

          # è¾“å‡ºåŸå§‹ JSON æ•°æ®ä»¥ä¾¿è°ƒè¯•
          echo "ğŸ“œ Raw versions JSON:"
          echo "$VERSIONS_JSON" | jq .

          # è¿‡æ»¤ name å­—æ®µåŒ…å« sha256: çš„ç‰ˆæœ¬ï¼ŒæŒ‰ created_at å€’åºæ’åº
          VERSIONS=$(echo "$VERSIONS_JSON" | jq -r '.[] | select(.name | startswith("sha256:")) | .id + "," + .created_at' | sort -t',' -k2 -r | cut -d',' -f1)

          # æ£€æŸ¥æ˜¯å¦æœ‰ SHA256 åç§°çš„ç‰ˆæœ¬
          if [ -z "$VERSIONS" ]; then
            echo "âœ… No SHA256-named versions found."
            exit 0
          fi

          # éå†å¹¶åˆ é™¤æ¯ä¸ª SHA256 åç§°çš„ç‰ˆæœ¬ï¼Œæ•è· HTTP 400 é”™è¯¯å¹¶è·³è¿‡
          for vid in $VERSIONS; do
            echo "ğŸ—‘ï¸ Deleting version ID: $vid"
            if ! gh api -X DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GH_TOKEN" \
              /user/packages/container/$PACKAGE_NAME/versions/$vid; then
              echo "âš ï¸ Failed to delete version ID: $vid (likely last tagged version, skipping)"
            else
              echo "âœ… Successfully deleted version ID: $vid"
            fi
          done
